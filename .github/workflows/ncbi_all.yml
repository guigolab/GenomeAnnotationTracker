name: Retrieve NCBI GFF3 Paths

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  retrieve-ncbi-gff3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install NCBI Datasets CLI and lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Install required NCBI packages
        run: |
          #retrieve packages and set permissions
          curl -O 'https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/dataformat'
          curl -O 'https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/datasets'
          chmod +x datasets dataformat
          
      - name: Retrieve Eukaryotic Genomes
        run: |
          ./datasets summary genome taxon 2759 --annotated --as-json-lines |
          ./dataformat tsv genome --fields accession >  assembly_accessions.txt
          
      - name: Extract Assembly Accessions and Generate FTP Paths
        run: |
          > ncbi_gff3_paths_base.tsv
          tail -n +2 assembly_accessions.txt | head -n 10 > assembly_accessions_10.txt
          cat assembly_accessions_10.txt
          # Create formatted FTP paths for each assembly accession
          while read -r accession; do
            # Generate the base path from the assembly accession
            base_path="ftp://ftp.ncbi.nlm.nih.gov/genomes/all/${accession:0:3}/${accession:4:3}/${accession:7:3}/${accession:10:3}"
            echo -e "${accession}\t${base_path}" >> ncbi_gff3_paths_base.tsv
          done < assembly_accessions_10.txt

      - name: Recursively Search for .gff.gz Files on NCBI FTP
        run: |
          # Add header to the TSV file
          echo -e "accession\tfull_path" > ncbi_all.tsv

          # Loop through base FTP paths
          while read -r accession base_path; do
            echo "Searching in $base_path"
            
            # Capture the directory to change into
            dir_to_cd=$(lftp -c "
              set net:timeout 10
              set net:max-retries 3
              open ftp.ncbi.nlm.nih.gov
              cd ${base_path#ftp://ftp.ncbi.nlm.nih.gov}
              cls -1 ${accession}*/ | head -n 1
            ")

            # If no directory is found, skip to the next accession
            [[ -z "$dir_to_cd" ]] && echo "No directory for $accession, skipping..." && continue

            echo "Found directory: $dir_to_cd"            
            # Use lftp to connect to the server and list all files in the directory
            lftp -c "
              set net:timeout 10
              set net:max-retries 3
              open ftp.ncbi.nlm.nih.gov
              cd ${base_path#ftp://ftp.ncbi.nlm.nih.gov}/$dir_to_cd
              cls -1 ${accession}*.gff.gz
              quit
            " | awk -v acc="$accession" -v base="$base_path" '
                  /\.gff\.gz$/ {
                    https_base = gensub(/^ftp:\/\//, "https://", 1, base)
                    print acc "\t" https_base "/" $NF
                  }
            ' >> ncbi_all.tsv
            
            # Remove the temporary raw output file
            rm $RAW_OUTPUT
            
          done < ncbi_gff3_paths_base.tsv


      - name: Commit & Push changes
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
